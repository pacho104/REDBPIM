/**
 * Project: wampy.js
 *
 * https://github.com/KSDaemon/wampy.js
 *
 * A lightweight client-side implementation of
 * WAMP (The WebSocket Application Messaging Protocol v2)
 * http://wamp.ws
 *
 * Provides asynchronous RPC/PubSub over WebSocket.
 *
 * Copyright 2014 KSDaemon. Licensed under the MIT License.
 * See @license text at http://www.opensource.org/licenses/mit-license.php
 *
 */
("function"==typeof define?function(a){define("Wampy",a)}:"object"==typeof exports?function(a){module.exports=a()}:function(a){this.Wampy=a()})(function(){function a(a){var b,c,d;return a?/^ws/.test(a)?a:/:\d{1,5}/.test(a)?(b="https:"===window.location.protocol?"wss://":"ws://",b+a):(b="https:"===window.location.protocol?"wss://":"ws://",c=""!==window.location.port?":"+window.location.port:"",d="/"===a[0]?a:"/"+a,b+window.location.hostname+c+d):(b="https:"===window.location.protocol?"wss://":"ws://",c=""!==window.location.port?":"+window.location.port:"",b+window.location.hostname+c+"/ws")}function b(b,c){var d=a(b);return"WebSocket"in window?c?new WebSocket(d,c):new WebSocket(d):"MozWebSocket"in window?c?new MozWebSocket(d,c):new MozWebSocket(d):null}var c={HELLO:1,WELCOME:2,ABORT:3,CHALLENGE:4,AUTHENTICATE:5,GOODBYE:6,HEARTBEAT:7,ERROR:8,PUBLISH:16,PUBLISHED:17,SUBSCRIBE:32,SUBSCRIBED:33,UNSUBSCRIBE:34,UNSUBSCRIBED:35,EVENT:36,CALL:48,CANCEL:49,RESULT:50,REGISTER:64,REGISTERED:65,UNREGISTER:66,UNREGISTERED:67,INVOCATION:68,INTERRUPT:69,YIELD:70},d={SUCCESS:{code:0,description:"Success!"},URI_ERROR:{code:1,description:"Topic URI doesn't meet requirements!"},NO_BROKER:{code:2,description:"Server doesn't provide broker role!"},NO_CALLBACK_SPEC:{code:3,description:"No required callback function specified!"},INVALID_PARAM:{code:4,description:"Invalid parameter(s) specified!"},NON_EXIST_SUBSCRIBE_CONFIRM:{code:5,description:"Received subscribe confirmation to non existent subscription!"},NON_EXIST_SUBSCRIBE_ERROR:{code:6,description:"Received error for non existent subscription!"},NON_EXIST_UNSUBSCRIBE:{code:7,description:"Trying to unsubscribe from non existent subscription!"},NON_EXIST_SUBSCRIBE_UNSUBSCRIBED:{code:8,description:"Received unsubscribe confirmation to non existent subscription!"},NON_EXIST_PUBLISH_ERROR:{code:9,description:"Received error for non existent publication!"},NON_EXIST_PUBLISH_PUBLISHED:{code:10,description:"Received publish confirmation for non existent publication!"},NON_EXIST_SUBSCRIBE_EVENT:{code:11,description:"Received event for non existent subscription!"},NO_DEALER:{code:12,description:"Server doesn't provide dealer role!"},NON_EXIST_CALL_RESULT:{code:13,description:"Received rpc result for non existent call!"},NON_EXIST_CALL_ERROR:{code:14,description:"Received rpc call error for non existent call!"},RPC_ALREADY_REGISTERED:{code:15,description:"RPC already registered!"},NON_EXIST_RPC_REG:{code:16,description:"Received rpc registration confirmation for non existent rpc!"},NON_EXIST_RPC_UNREG:{code:17,description:"Received rpc unregistration confirmation for non existent rpc!"},NON_EXIST_RPC_ERROR:{code:18,description:"Received error for non existent rpc!"},NON_EXIST_RPC_INVOCATION:{code:19,description:"Received invocation for non existent rpc!"}},e=function(a,c){switch(this.version="v1.0.3",this._url="string"==typeof arguments[0]?a:void 0,this._protocols=["wamp.2.json"],this._wamp_features={agent:"Wampy.js "+this.version,roles:{publisher:{features:{subscriber_blackwhite_listing:!0,publisher_exclusion:!0,publisher_identification:!0}},subscriber:{},caller:{features:{callee_blackwhite_listing:!0,caller_exclusion:!0,caller_identification:!0}},callee:{features:{caller_identification:!0}}}},this._cache={sessionId:null,server_wamp_features:{roles:{}},isSayingGoodbye:!1,opStatus:{code:0,description:"Success!"},timer:null,reconnectingAttempts:0},this._ws=null,this._wsQueue=[],this._requests={},this._calls={},this._subscriptions={},this._subsTopics=[],this._rpcRegs={},this._rpcNames=[],this._options={autoReconnect:!0,reconnectInterval:2e3,maxRetries:25,transportEncoding:"json",realm:window.location.hostname,onConnect:null,onClose:null,onError:null,onReconnect:null},arguments.length){case 1:"string"!=typeof arguments[0]&&(this._options=this._merge(this._options,arguments[0]));break;case 2:this._options=this._merge(this._options,c)}this._setWsProtocols(),this._ws=b(this._url,this._protocols),this._initWsCallbacks()};return e.prototype._getReqId=function(){var a;do a=Math.floor(1e14*Math.random());while(a in this._requests);return a},e.prototype._merge=function(){var a,b,c={},d=arguments.length;for(a=0;d>a;a++)for(b in arguments[a])c[b]=arguments[a][b];return c},e.prototype._isArray=function(a){return!!a&&a.constructor===Array},e.prototype._isObject=function(a){return a===Object(a)&&"[object Array]"!==Object.prototype.toString.call(a)},e.prototype._isPlainObject=function(a){return!!a&&a.constructor===Object},e.prototype._setWsProtocols=function(){void 0!==window.msgpack&&(this._protocols="msgpack"===this._options.transportEncoding?["wamp.2.msgpack","wamp.2.json"]:["wamp.2.json","wamp.2.msgpack"])},e.prototype._validateURI=function(a){var b=/^([0-9a-z_]{2,}\.)*([0-9a-z_]{2,})$/;return b.test(a)&&0!==a.indexOf("wamp")?!0:!1},e.prototype._encode=function(a){var b;if("msgpack"!==this._options.transportEncoding)return JSON.stringify(a);try{return b=new Uint8Array(msgpack.encode(a)),b.buffer}catch(c){throw new Error("[wampy] no msgpack encoder available!")}},e.prototype._decode=function(a){if("msgpack"!==this._options.transportEncoding)return JSON.parse(a);try{return msgpack.decode(a)}catch(b){throw new Error("[wampy] no msgpack encoder available!")}},e.prototype._send=function(a){if(a&&this._wsQueue.push(this._encode(a)),1===this._ws.readyState&&this._cache.sessionId)for(;this._wsQueue.length;)this._ws.send(this._wsQueue.shift())},e.prototype._resetState=function(){this._wsQueue=[],this._subscriptions={},this._subsTopics=[],this._requests={},this._calls={},this._rpcRegs={},this._rpcNames=[],this._cache={reconnectingAttempts:0}},e.prototype._initWsCallbacks=function(){var a=this;this._ws.onopen=function(){a._wsOnOpen.call(a)},this._ws.onclose=function(b){a._wsOnClose.call(a,b)},this._ws.onmessage=function(b){a._wsOnMessage.call(a,b)},this._ws.onerror=function(b){a._wsOnError.call(a,b)}},e.prototype._wsOnOpen=function(){var a;a=this._ws.protocol.split("."),this._options.transportEncoding=a[2],"msgpack"===this._options.transportEncoding&&(this._ws.binaryType="arraybuffer"),this._ws.send(this._encode([c.HELLO,this._options.realm,this._wamp_features]))},e.prototype._wsOnClose=function(){var a=this;(this._cache.sessionId||this._cache.reconnectingAttempts)&&this._options.autoReconnect&&this._cache.reconnectingAttempts<this._options.maxRetries&&!this._cache.isSayingGoodbye?(this._cache.sessionId=null,this._cache.timer=window.setTimeout(function(){a._wsReconnect.call(a)},this._options.reconnectInterval)):(this._options.onClose&&this._options.onClose(),this._resetState(),this._ws=null)},e.prototype._wsOnMessage=function(a){var b,e,f,g,h,i;switch(b=this._decode(a.data),b[0]){case c.WELCOME:this._cache.reconnectingAttempts?(f=1,this._cache.reconnectingAttempts=0):f=0,this._cache.sessionId=b[1],this._cache.server_wamp_features=b[2],this._options.onConnect&&this._options.onConnect(),1===f&&(this._renewSubscriptions(),this._renewRegistrations()),this._send();break;case c.ABORT:this._options.onError&&this._options.onError(b[1].message?b[1].message:b[2]),this._ws.close();break;case c.CHALLENGE:break;case c.GOODBYE:this._cache.isSayingGoodbye||(this._cache.isSayingGoodbye=!0,this._send([c.GOODBYE,{},"wamp.error.goodbye_and_out"])),this._cache.sessionId=null,this._ws.close();break;case c.HEARTBEAT:break;case c.ERROR:switch(b[1]){case c.SUBSCRIBE:case c.UNSUBSCRIBE:this._requests[b[2]]?(this._requests[b[2]].callbacks.onError&&this._requests[b[2]].callbacks.onError(b[4]),delete this._requests[b[2]]):this._cache.opStatus=d.NON_EXIST_SUBSCRIBE_ERROR;break;case c.PUBLISH:this._requests[b[2]]?(this._requests[b[2]].callbacks.onError&&this._requests[b[2]].callbacks.onError(b[4]),delete this._requests[b[2]]):this._cache.opStatus=d.NON_EXIST_PUBLISH_ERROR;break;case c.REGISTER:case c.UNREGISTER:this._requests[b[2]]?(this._requests[b[2]].callbacks.onError&&this._requests[b[2]].callbacks.onError(b[4]),delete this._requests[b[2]]):this._cache.opStatus=d.NON_EXIST_RPC_ERROR;break;case c.INVOCATION:break;case c.CALL:if(this._calls[b[2]].onError){switch(b.length){case 5:g=null;break;case 6:g=b[5];break;case 7:g=b[6]}this._calls[b[2]].onError(g),delete this._calls[b[2]]}else this._cache.opStatus=d.NON_EXIST_CALL_ERROR}break;case c.SUBSCRIBED:this._requests[b[1]]?(this._subscriptions[this._requests[b[1]].topic]=this._subscriptions[b[2]]={id:b[2],callbacks:[this._requests[b[1]].callbacks.onEvent]},this._subsTopics.push(this._requests[b[1]].topic),this._requests[b[1]].callbacks.onSuccess&&this._requests[b[1]].callbacks.onSuccess(),delete this._requests[b[1]]):this._cache.opStatus=d.NON_EXIST_SUBSCRIBE_CONFIRM;break;case c.UNSUBSCRIBED:this._requests[b[1]]?(e=this._subscriptions[this._requests[b[1]].topic].id,delete this._subscriptions[this._requests[b[1]].topic],delete this._subscriptions[e],f=this._subsTopics.indexOf(this._requests[b[1]].topic),f>=0&&this._subsTopics.splice(f,1),this._requests[b[1]].callbacks.onSuccess&&this._requests[b[1]].callbacks.onSuccess(),delete this._requests[b[1]]):this._cache.opStatus=d.NON_EXIST_SUBSCRIBE_UNSUBSCRIBED;break;case c.PUBLISHED:this._requests[b[1]]?(this._requests[b[1]].callbacks.onSuccess&&this._requests[b[1]].callbacks.onSuccess(),delete this._requests[b[1]]):this._cache.opStatus=d.NON_EXIST_PUBLISH_PUBLISHED;break;case c.EVENT:if(this._subscriptions[b[1]]){switch(b.length){case 4:g=null;break;case 5:g=b[4];break;case 6:g=b[5]}for(f=this._subscriptions[b[1]].callbacks.length;f--;)this._subscriptions[b[1]].callbacks[f](g)}else this._cache.opStatus=d.NON_EXIST_SUBSCRIBE_EVENT;break;case c.RESULT:if(this._calls[b[1]]){switch(b.length){case 3:g=null;break;case 4:g=b[3];break;case 5:g=b[4]}this._calls[b[1]].onSuccess(g),delete this._calls[b[1]]}else this._cache.opStatus=d.NON_EXIST_CALL_RESULT;break;case c.REGISTER:break;case c.REGISTERED:this._requests[b[1]]?(this._rpcRegs[this._requests[b[1]].topic]=this._rpcRegs[b[2]]={id:b[2],callbacks:[this._requests[b[1]].callbacks.rpc]},this._rpcNames.push(this._requests[b[1]].topic),this._requests[b[1]].callbacks.onSuccess&&this._requests[b[1]].callbacks.onSuccess(),delete this._requests[b[1]]):this._cache.opStatus=d.NON_EXIST_RPC_REG;break;case c.UNREGISTER:break;case c.UNREGISTERED:this._requests[b[1]]?(e=this._rpcRegs[this._requests[b[1]].topic].id,delete this._rpcRegs[this._requests[b[1]].topic],delete this._rpcRegs[e],f=this._rpcNames.indexOf(this._requests[b[1]].topic),f>=0&&this._rpcNames.splice(f,1),this._requests[b[1]].callbacks.onSuccess&&this._requests[b[1]].callbacks.onSuccess(),delete this._requests[b[1]]):this._cache.opStatus=d.NON_EXIST_RPC_UNREG;break;case c.INVOCATION:if(this._rpcRegs[b[2]]){switch(b.length){case 4:g=null;break;case 5:g=b[4];break;case 6:g=b[5]}try{h=this._rpcRegs[b[2]].callbacks[0](g)}catch(j){return void this._send([c.ERROR,c.INVOCATION,b[1],{},"wamp.error.invocation_exception"])}i=this._isArray(h)?[c.YIELD,b[1],{},h]:this._isPlainObject(h)?[c.YIELD,b[1],{},[],h]:void 0===h?[c.YIELD,b[1],{}]:[c.YIELD,b[1],{},[h]],this._send(i)}else this._send([c.ERROR,c.INVOCATION,b[1],{},"wamp.error.no_such_procedure"]),this._cache.opStatus=d.NON_EXIST_RPC_INVOCATION;break;case c.INTERRUPT:break;case c.YIELD:}},e.prototype._wsOnError=function(a){this._options.onError&&this._options.onError(a)},e.prototype._wsReconnect=function(){this._options.onReconnect&&this._options.onReconnect(),this._cache.reconnectingAttempts++,this._ws=b(this._url,this._protocols),this._initWsCallbacks()},e.prototype._renewSubscriptions=function(){var a,b,c=this._subscriptions,d=this._subsTopics;for(this._subscriptions={},this._subsTopics=[],a=d.length;a--;)for(b=c[d[a]].callbacks.length;b--;)this.subscribe(d[a],c[d[a]].callbacks[b])},e.prototype._renewRegistrations=function(){var a,b=this._rpcRegs,c=this._rpcNames;for(this._rpcRegs={},this._rpcNames=[],a=c.length;a--;)this.register(c[a],{rpc:b[c[a]].callbacks[0]})},e.prototype.options=function(a){return void 0===a?this._options:this._isPlainObject(a)?(this._options=this._merge(this._options,a),this):void 0},e.prototype.getOpStatus=function(){return this._cache.opStatus},e.prototype.getSessionId=function(){return this._cache.sessionId},e.prototype.connect=function(a){return a&&(this._url=a),this._setWsProtocols(),this._ws=b(this._url,this._protocols),this._initWsCallbacks(),this},e.prototype.disconnect=function(){return this._cache.sessionId?(this._cache.isSayingGoodbye=!0,this._send([c.GOODBYE,{},"wamp.error.system_shutdown"])):this._ws&&this._ws.close(),this._cache.opStatus=d.SUCCESS,this},e.prototype.abort=function(){return this._cache.sessionId||1!==this._ws.readyState||(this._send([c.ABORT,{},"wamp.error.abort"]),this._cache.sessionId=null),this._ws.close(),this._cache.opStatus=d.SUCCESS,this},e.prototype.subscribe=function(a,b){var e;if(this._cache.sessionId&&!this._cache.server_wamp_features.roles.broker)return this._cache.opStatus=d.NO_BROKER,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this;if(!this._validateURI(a))return this._cache.opStatus=d.URI_ERROR,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this;if("function"==typeof b)b={onEvent:b};else if(!this._isPlainObject(b)||void 0===b.onEvent)return this._cache.opStatus=d.NO_CALLBACK_SPEC,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this;return this._subscriptions[a]?(this._subscriptions[a].callbacks.indexOf(b.onEvent)<0&&this._subscriptions[a].callbacks.push(b.onEvent),b.onSuccess&&b.onSuccess()):(e=this._getReqId(),this._requests[e]={topic:a,callbacks:b},this._send([c.SUBSCRIBE,e,{},a])),this._cache.opStatus=d.SUCCESS,this},e.prototype.unsubscribe=function(a,b){var e,f=-1;return this._cache.sessionId&&!this._cache.server_wamp_features.roles.broker?(this._cache.opStatus=d.NO_BROKER,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this):this._subscriptions[a]?(e=this._getReqId(),void 0===b?(this._subscriptions[a].callbacks=[],b={}):"function"==typeof b?(f=this._subscriptions[a].callbacks.indexOf(b),b={onEvent:b}):f=this._subscriptions[a].callbacks.indexOf(b.onEvent),f>=0&&this._subscriptions[a].callbacks.splice(f,1),this._subscriptions[a].callbacks.length?(this._cache.opStatus=d.SUCCESS,this):(this._requests[e]={topic:a,callbacks:b},this._send([c.UNSUBSCRIBE,e,this._subscriptions[a].id]),this._cache.opStatus=d.SUCCESS,this)):(this._cache.opStatus=d.NON_EXIST_UNSUBSCRIBE,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this)},e.prototype.publish=function(a,b,e,f){var g,h,i={},j=!1;if(this._cache.sessionId&&!this._cache.server_wamp_features.roles.broker)return this._cache.opStatus=d.NO_BROKER,this._isPlainObject(e)&&e.onError&&e.onError(this._cache.opStatus.description),this;if(!this._validateURI(a))return this._cache.opStatus=d.URI_ERROR,this._isPlainObject(e)&&e.onError&&e.onError(this._cache.opStatus.description),this;if(this._isPlainObject(e)&&(i.acknowledge=!0),void 0!==f&&(this._isPlainObject(f)?(f.exclude&&(this._isArray(f.exclude)?i.exclude=f.exclude:"number"==typeof f.exclude?i.exclude=[f.exclude]:j=!0),f.eligible&&(this._isArray(f.eligible)?i.eligible=f.eligible:"number"==typeof f.eligible?i.eligible=[f.eligible]:j=!0),f.hasOwnProperty("exclude_me")&&(i.exclude_me=f.exclude_me!==!1),f.hasOwnProperty("disclose_me")&&(i.disclose_me=f.disclose_me===!0)):j=!0,j))return this._cache.opStatus=d.INVALID_PARAM,this._isPlainObject(e)&&e.onError&&e.onError(this._cache.opStatus.description),this;switch(g=this._getReqId(),arguments.length){case 1:h=[c.PUBLISH,g,i,a];break;case 2:h=this._isArray(b)?[c.PUBLISH,g,i,a,b]:this._isPlainObject(b)?[c.PUBLISH,g,i,a,[],b]:[c.PUBLISH,g,i,a,[b]];break;default:this._requests[g]={topic:a,callbacks:e},h=this._isArray(b)?[c.PUBLISH,g,i,a,b]:this._isPlainObject(b)?[c.PUBLISH,g,i,a,[],b]:[c.PUBLISH,g,i,a,[b]]}return this._send(h),this._cache.opStatus=d.SUCCESS,this},e.prototype.call=function(a,b,e,f){var g,h,i={},j=!1;if(this._cache.sessionId&&!this._cache.server_wamp_features.roles.dealer)return this._cache.opStatus=d.NO_DEALER,this._isPlainObject(e)&&e.onError&&e.onError(this._cache.opStatus.description),this;if(!this._validateURI(a))return this._cache.opStatus=d.URI_ERROR,this._isPlainObject(e)&&e.onError&&e.onError(this._cache.opStatus.description),this;if("function"==typeof e)e={onSuccess:e};else if(!this._isPlainObject(e)||void 0===e.onSuccess)return this._cache.opStatus=d.NO_CALLBACK_SPEC,this._isPlainObject(e)&&e.onError&&e.onError(this._cache.opStatus.description),this;if(void 0!==f&&(this._isPlainObject(f)?(f.exclude&&(this._isArray(f.exclude)?i.exclude=f.exclude:"number"==typeof f.exclude?i.exclude=[f.exclude]:j=!0),f.eligible&&(this._isArray(f.eligible)?i.eligible=f.eligible:"number"==typeof f.eligible?i.eligible=[f.eligible]:j=!0),f.hasOwnProperty("exclude_me")&&(i.exclude_me=f.exclude_me!==!1),f.hasOwnProperty("disclose_me")&&(i.disclose_me=f.disclose_me===!0)):j=!0,j))return this._cache.opStatus=d.INVALID_PARAM,this._isPlainObject(e)&&e.onError&&e.onError(this._cache.opStatus.description),this;do g=this._getReqId();while(g in this._calls);return this._calls[g]=e,h=null===b?[c.CALL,g,i,a]:this._isArray(b)?[c.CALL,g,i,a,b]:this._isPlainObject(b)?[c.CALL,g,i,a,[],b]:[c.CALL,g,i,a,[b]],this._send(h),this._cache.opStatus=d.SUCCESS,this},e.prototype.register=function(a,b){var e;if(this._cache.sessionId&&!this._cache.server_wamp_features.roles.dealer)return this._cache.opStatus=d.NO_DEALER,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this;if(!this._validateURI(a))return this._cache.opStatus=d.URI_ERROR,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this;if("function"==typeof b)b={rpc:b};else if(!this._isPlainObject(b)||void 0===b.rpc)return this._cache.opStatus=d.NO_CALLBACK_SPEC,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this;return this._rpcRegs[a]?(this._cache.opStatus=d.RPC_ALREADY_REGISTERED,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description)):(e=this._getReqId(),this._requests[e]={topic:a,callbacks:b},this._send([c.REGISTER,e,{},a]),this._cache.opStatus=d.SUCCESS),this},e.prototype.unregister=function(a,b){var e;return this._cache.sessionId&&!this._cache.server_wamp_features.roles.dealer?(this._cache.opStatus=d.NO_DEALER,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this):this._validateURI(a)?("function"==typeof b&&(b={onSuccess:b}),this._rpcRegs[a]?(e=this._getReqId(),this._requests[e]={topic:a,callbacks:b},this._send([c.UNREGISTER,e,this._rpcRegs[a].id]),this._cache.opStatus=d.SUCCESS):(this._cache.opStatus=d.RPC_ALREADY_REGISTERED,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description)),this):(this._cache.opStatus=d.URI_ERROR,this._isPlainObject(b)&&b.onError&&b.onError(this._cache.opStatus.description),this)},e});
